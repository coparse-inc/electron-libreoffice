<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Test</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
      }
      button {
        margin: 0.5em;
        min-width: 10em;
      }
    </style>
  </head>
  <body style="height: 100vh">
    <input
      id="el-picker"
      type="file"
      accept=".doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
    />

    <div style="display: flex">
      <button type="button" onclick="toggleTrackChanges()">
        TOGGLE TRACK CHANGES
      </button>
      <button type="button" onclick="acceptTrackChange()">Accept TC</button>
      <button type="button" onclick="rejectTrackChange()">Reject TC</button>
    </div>
    <div style="display: flex">
      <button type="button" onclick="gotoOutline()">Goto Outline</button>
      <button type="button" onclick="insertTable()">Insert Table</button>
    </div>
    <div style="display: flex">
      <button type="button" onclick="zoomIn()">Zoom In</button>
      <button type="button" onclick="zoomOut()">Zoom Out</button>
    </div>
    <script src="wrapper.js"></script>
    <div style="display: flex; height: 100%;">
      <div style="display: flex; width: 256px;">
        <office-doc id="el-thumb" />
      </div>
      <div style="display: flex; width: calc(100% - 256px);">
        <office-doc id="el-embed" />
      </div>
    </div>
    <script>
      const picker = document.getElementById('el-picker');
      const embed = document.getElementById('el-embed');
      const thumb = document.getElementById('el-thumb');

      libreoffice.on('status_indicator_set_value', (x) => {
        console.log(x);
      });

      libreoffice.on('status_changed', (x) => {
        console.log('lo', x);
      });

      libreoffice.on('window', (x) => {
        console.log('lo', x);
      });

      let globalDoc;
      let zoom = 1.0;
      picker.onchange = () => {
        if (picker.files.length === 1) {
          const uri = encodeURI(
            'file:///' + picker.files[0].path.replace(/\\/g, '/')
          );
          const doc = libreoffice.loadDocument(uri);
          doc.on('ready', (x) => {
            globalDoc = doc;
            console.log('Document Ready', x);

            const encodedData = new TextEncoder().encode(
              'testing 123, will is cool'
            );

            const clipboardData = [
              {
                mimeType: 'text/plain',
                buffer: encodedData.buffer,
              },
            ];
          });

          embed.renderDocument(doc);
          thumb.renderDocument(doc);
          thumb.setZoom(0.1);
          embed.focus();
        }
      };

      function zoomIn() {
        zoom += 0.1;
        embed.setZoom(zoom);
      }
      function zoomOut() {
        if (zoom < 0.2) return;
        zoom -= 0.1;
        embed.setZoom(zoom);
      }

      // Used as POC to show how to structure outline data
      function constructBookmarkTree(outline) {
        const outlineTree = {};
        attachChildrenToNodes(outline, outlineTree);
        return outlineTree;
      }

      function attachChildrenToNodes(outline, outlineTree) {
        for (const node of outline) {
          outlineTree[node.id] = node;
          const children = outline.filter((o) => o.parent === node.id);
          outlineTree[node.id].children = children;
        }
      }

      function trackChangesWindow() {
        globalDoc.postUnoCommand('.uno:AcceptTrackedChanges');
      }
      function toggleTrackChanges() {
        globalDoc.postUnoCommand('.uno:TrackChanges');
      }
      function acceptTrackChange() {
        globalDoc.postUnoCommand('.uno:AcceptTrackedChange');
      }
      function rejectTrackChange() {
        globalDoc.postUnoCommand('.uno:RejectTrackedChange');
      }
      function gotoOutline() {
        const outline = doc.getCommandValues('.uno:GetOutline');

        if (outline.outline) {
          // CONSTRUCT Tree for bookmarks
          console.log('Outline tree', constructBookmarkTree(outline.outline));
        }
        console.log('OUTLINE', globalDoc.gotoOutline(1));
      }
      function insertTable() {
        globalDoc.postUnoCommand('.uno:CreateTable', {
          Row: { value: 4, type: 'long' },
          Col: { value: 3, type: 'long' },
        });
      }
    </script>
  </body>
</html>
