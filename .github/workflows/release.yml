name: Build and release for all platforms

on:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  check_version:
    name: Check version
    uses: ./.github/workflows/check-version-tag.yml
  fetch:
    needs: [check_version]
    if: ${{ needs.check_version.outputs.should_run != 'false' }}
    name: Fetch
    uses: ./.github/workflows/fetch.yml
    with:
      runner_label: macro-linux
    secrets:
      EC2_RUNNER_AWS_ID: ${{ secrets.EC2_RUNNER_AWS_ID }}
      EC2_RUNNER_AWS_SECRET: ${{ secrets.EC2_RUNNER_AWS_SECRET }}
      instance_id: ${{ secrets.LINUX_RUNNER_INSTANCE_ID }}
  build_release:
    needs: [check_version, fetch]
    if: ${{ needs.check_version.outputs.should_run != 'false' }}
    strategy:
      matrix:
        include:
          # - name: Windows x64
          #   os: macro-windows
          #   runner: WINDOWS_RUNNER_INSTANCE_ID
          #   working_dir: /r/el
          - name: Linux x64
            os: macro-linux
            runner: LINUX_RUNNER_INSTANCE_ID
            working_dir: /r/el
    name: ${{ matrix.name }}
    uses: ./.github/workflows/build.yml
    with:
      runner_label: ${{ matrix.os }}
      working_dir: ${{ matrix.working_dir }}
      version: ${{ needs.check_version.outputs.version }}
    secrets:
      EC2_RUNNER_AWS_ID: ${{ secrets.EC2_RUNNER_AWS_ID }}
      EC2_RUNNER_AWS_SECRET: ${{ secrets.EC2_RUNNER_AWS_SECRET }}
      instance_id: ${{ secrets[matrix.runner] }}
